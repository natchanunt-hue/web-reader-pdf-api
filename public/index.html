<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web to PDF (Server Side)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        h2 { margin-top: 0; color: #333; }
        input { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; transition: 0.3s; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; color: #666; font-size: 14px; min-height: 20px; white-space: pre-wrap; }
        .tips { font-size: 12px; color: #999; margin-top: 20px; text-align: left; }
    </style>
</head>
<body>

<div class="card">
    <h2>üìÑ Web to PDF (Pro)</h2>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á Browser ‡∏à‡∏£‡∏¥‡∏á (‡πÅ‡∏Å‡πâ Cloudflare)</p>
    
    <input type="text" id="urlInput" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... (‡πÄ‡∏ä‡πà‡∏ô Dailynews, Sanook)">
    <button id="btnDownload" onclick="downloadPdf()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
    
    <div id="status"></div>

    <div class="tips">
        * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 10-30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ<br>
        * ‡∏´‡∏≤‡∏Å‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (Server ‡∏≠‡∏≤‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏∑‡πà‡∏ô)
    </div>
</div>

<script>
    async function downloadPdf() {
        const url = document.getElementById('urlInput').value;
        const btn = document.getElementById('btnDownload');
        const status = document.getElementById('status');

        if (!url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');

        // UI Loading
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
        status.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Chrome ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢)...";
        status.style.color = "#666";

        try {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend
            const response = await fetch(`/api/scrape?url=${encodeURIComponent(url)}`);

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Error ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!response.ok) {
                const text = await response.text();
                try {
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô Error ‡πÅ‡∏ö‡∏ö JSON
                    const errJson = JSON.parse(text);
                    throw new Error(errJson.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å Server');
                } catch (e) {
                    // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô JSON ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ Server ‡∏•‡πà‡∏° (HTML error)
                    throw new Error(`Server Error (${response.status}): ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Memory ‡πÄ‡∏ï‡πá‡∏° ‡∏´‡∏£‡∏∑‡∏≠ Cloud Run ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`);
                }
            }

            // ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ: ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Header Content-Disposition ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const disposition = response.headers.get('Content-Disposition');
            let filename = `document_${new Date().getTime()}.pdf`;

            if (disposition) {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏Å‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà Backend ‡∏™‡πà‡∏á‡∏°‡∏≤
                const match = disposition.match(/filename\*=UTF-8''(.+)/);
                if (match && match[1]) {
                    filename = decodeURIComponent(match[1]);
                }
            }

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = filename; 
            document.body.appendChild(a);
            a.click();
            a.remove();
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
            window.URL.revokeObjectURL(downloadUrl);

            status.innerText = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß";
            status.style.color = "green";

        } catch (error) {
            console.error(error);
            status.innerText = "‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
            status.style.color = "red";
        } finally {
            btn.disabled = false;
            btn.innerText = "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF";
        }
    }
</script>

</body>
</html>